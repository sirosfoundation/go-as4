#!/bin/bash
# Pre-commit hook for go-as4
# Install: ln -sf ../../scripts/pre-commit .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Check Go formatting
echo "Checking Go formatting..."
UNFORMATTED=$(gofmt -s -l . 2>/dev/null | grep -v vendor || true)
if [ -n "$UNFORMATTED" ]; then
    echo "ERROR: The following files are not formatted:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run 'gofmt -s -w .' to fix."
    exit 1
fi

# Run go vet
echo "Running go vet..."
go vet ./... 2>&1 || {
    echo "ERROR: go vet found issues"
    exit 1
}

# Check that go.mod is tidy
echo "Checking go.mod is tidy..."
cp go.mod go.mod.backup
cp go.sum go.sum.backup 2>/dev/null || true
go mod tidy
if ! diff -q go.mod go.mod.backup > /dev/null 2>&1; then
    mv go.mod.backup go.mod
    mv go.sum.backup go.sum 2>/dev/null || true
    echo "ERROR: go.mod is not tidy. Run 'go mod tidy'."
    exit 1
fi
rm go.mod.backup go.sum.backup 2>/dev/null || true

echo "Pre-commit checks passed!"
